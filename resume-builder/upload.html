<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Resume — AI Resume Builder</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1a1a2e; background: #f8f9fa; }

        .header { background: linear-gradient(135deg, #0f0c29, #302b63); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 1.6rem; }
        .header a { color: #00b4d8; text-decoration: none; }

        .container { max-width: 700px; margin: 30px auto; padding: 0 20px; }

        .form-section { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .form-section h2 { margin-bottom: 8px; color: #302b63; border-bottom: 2px solid #00b4d8; padding-bottom: 10px; }
        .form-section .subtitle { color: #777; font-size: 0.9rem; margin-bottom: 18px; }

        label { display: block; font-weight: 600; margin: 15px 0 5px; }
        input, textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #00b4d8; box-shadow: 0 0 0 3px rgba(0,180,216,0.1); }
        textarea { resize: vertical; min-height: 120px; }

        .row { display: flex; gap: 15px; }
        .row > div { flex: 1; }

        .upload-zone { border: 2px dashed #00b4d8; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f0faff; }
        .upload-zone:hover { background: #e0f4ff; border-color: #0096c7; }
        .upload-zone.has-file { border-color: #22c55e; background: #f0fdf4; }
        .upload-zone input[type="file"] { display: none; }
        .upload-zone .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .upload-zone .filename { font-weight: 600; color: #22c55e; margin-top: 8px; }

        .divider { text-align: center; margin: 20px 0; color: #aaa; font-size: 0.9rem; position: relative; }
        .divider::before, .divider::after { content: ''; position: absolute; top: 50%; width: 40%; height: 1px; background: #ddd; }
        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .submit-section { text-align: center; padding: 20px 0; }
        .submit-btn { background: #00b4d8; color: white; padding: 16px 50px; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .submit-btn:hover { background: #0096c7; transform: translateY(-2px); }
        .submit-btn:disabled { background: #aaa; transform: none; cursor: not-allowed; }

        .cost-note { text-align: center; color: #777; margin-top: 10px; font-size: 0.9rem; }

        .steps-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; }
        .step-dot { width: 12px; height: 12px; border-radius: 50%; background: #ddd; }
        .step-dot.active { background: #00b4d8; }

        .status-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .status-box { background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 450px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #eee; border-top: 4px solid #00b4d8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-box .step-progress { margin-top: 15px; text-align: left; padding: 0 10px; }
        .status-box .step-item { padding: 6px 0; color: #aaa; font-size: 0.9rem; }
        .status-box .step-item.active { color: #00b4d8; font-weight: 600; }
        .status-box .step-item.done { color: #22c55e; }

        @media (max-width: 600px) { .row { flex-direction: column; gap: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <h1><a href="index.html">AI Resume Builder</a> &mdash; Build Your Application</h1>
    </div>

    <div class="container">
        <form id="resume-form">
            <!-- Step 1: Upload Resume -->
            <div class="form-section">
                <h2>1. Your Resume</h2>
                <p class="subtitle">Upload your current resume and our AI will extract all your experience, skills, and education automatically.</p>

                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('resume-file').click()">
                    <input type="file" id="resume-file" accept=".pdf,.docx,.doc,.txt" />
                    <div class="icon">&#128196;</div>
                    <p><strong>Click to upload</strong> or drag and drop</p>
                    <p style="color: #999; font-size: 0.85rem; margin-top: 5px;">PDF, DOCX, or TXT (max 5MB)</p>
                    <p class="filename" id="file-name" style="display:none;"></p>
                </div>

                <div class="divider">or paste your resume text</div>

                <textarea id="resume-text" name="resume_text" rows="8" placeholder="Paste the full text of your current resume here...&#10;&#10;Include your experience, education, skills, contact info — everything on your resume."></textarea>
            </div>

            <!-- Step 2: Job Description -->
            <div class="form-section">
                <h2>2. Job Description</h2>
                <p class="subtitle">Paste the job posting. Our AI will tailor your resume to match the exact requirements.</p>
                <textarea id="job-posting" name="job_posting_text" rows="8" placeholder="Paste the entire job posting here — include title, company, requirements, responsibilities, qualifications..." required></textarea>
            </div>

            <!-- Step 3: Email -->
            <div class="form-section">
                <h2>3. Delivery</h2>
                <p class="subtitle">We'll email your tailored resume and cover letter as PDFs.</p>
                <div class="row">
                    <div>
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required placeholder="jane@example.com">
                    </div>
                    <div>
                        <label for="name">Name (for the cover letter)</label>
                        <input type="text" id="name" name="name" placeholder="Jane Doe">
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="submit-section">
                <button type="submit" class="submit-btn" id="submit-btn">Generate My Resume &amp; Cover Letter — $9.99</button>
                <p class="cost-note">Secure payment via Stripe. PDFs delivered to your email in ~2 minutes.</p>
            </div>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div class="status-overlay" id="status-overlay">
        <div class="status-box">
            <div class="spinner"></div>
            <h2 id="status-title">Generating Your Resume...</h2>
            <p id="status-message">Our AI is tailoring your resume and writing your cover letter.</p>
            <div class="step-progress" id="step-progress">
                <div class="step-item active" id="step-parse-resume">Parsing your resume...</div>
                <div class="step-item" id="step-parse-job">Analyzing job requirements...</div>
                <div class="step-item" id="step-tailor">Tailoring your resume...</div>
                <div class="step-item" id="step-cover">Writing cover letter...</div>
                <div class="step-item" id="step-pdf">Building PDFs...</div>
            </div>
        </div>
    </div>

    <script>
        // File upload handling
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('resume-file');
        const fileName = document.getElementById('file-name');
        const resumeText = document.getElementById('resume-text');
        let uploadedFileBase64 = null;
        let uploadedFileName = null;

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Maximum size is 5MB.');
                return;
            }

            uploadedFileName = file.name;
            fileName.textContent = file.name;
            fileName.style.display = 'block';
            uploadZone.classList.add('has-file');
            resumeText.value = '';
            resumeText.placeholder = 'Resume file uploaded — no need to paste text.';

            // Read file as base64
            const reader = new FileReader();
            reader.onload = function(e) {
                // Strip the data:... prefix to get raw base64
                uploadedFileBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.style.borderColor = '#0096c7';
            uploadZone.style.background = '#e0f4ff';
        });
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.style.borderColor = '#00b4d8';
            uploadZone.style.background = '#f0faff';
        });
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Clear file when user types in text area
        resumeText.addEventListener('input', function() {
            if (resumeText.value.trim()) {
                uploadedFileBase64 = null;
                uploadedFileName = null;
                fileName.style.display = 'none';
                uploadZone.classList.remove('has-file');
                fileInput.value = '';
            }
        });

        // Animated progress steps
        function animateSteps() {
            const steps = ['step-parse-resume', 'step-parse-job', 'step-tailor', 'step-cover', 'step-pdf'];
            let current = 0;
            const interval = setInterval(() => {
                if (current > 0) {
                    document.getElementById(steps[current - 1]).classList.remove('active');
                    document.getElementById(steps[current - 1]).classList.add('done');
                    document.getElementById(steps[current - 1]).textContent = document.getElementById(steps[current - 1]).textContent.replace('...', ' ✓');
                }
                if (current < steps.length) {
                    document.getElementById(steps[current]).classList.add('active');
                    current++;
                } else {
                    clearInterval(interval);
                }
            }, 12000); // ~60s total / 5 steps
            return interval;
        }

        // Form submission
        document.getElementById('resume-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            // Validate: must have either uploaded file or pasted text
            if (!uploadedFileBase64 && !resumeText.value.trim()) {
                alert('Please upload your resume or paste your resume text.');
                return;
            }

            const overlay = document.getElementById('status-overlay');
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');

            overlay.style.display = 'flex';
            const progressInterval = animateSteps();

            // Build request payload
            const payload = {
                email: formData.get('email'),
                name: formData.get('name') || '',
                job_posting_text: formData.get('job_posting_text'),
                stripe_session_id: 'test_session',
                tier: new URLSearchParams(window.location.search).get('tier') || 'single'
            };

            // Send resume as text or base64 file
            if (uploadedFileBase64) {
                payload.resume_file_base64 = uploadedFileBase64;
                payload.resume_file_name = uploadedFileName;
            } else {
                payload.resume_text = resumeText.value.trim();
            }

            sessionStorage.setItem('resume_email', formData.get('email'));

            try {
                const response = await fetch('http://34.193.98.97:5678/webhook/resume-builder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                clearInterval(progressInterval);

                if (response.ok) {
                    window.location.href = 'status.html?status=success';
                } else {
                    statusTitle.textContent = 'Something went wrong';
                    statusMessage.textContent = 'Please try again or contact support at wmarceau@marceausolutions.com';
                    document.getElementById('step-progress').style.display = 'none';
                }
            } catch (err) {
                clearInterval(progressInterval);
                statusTitle.textContent = 'Connection error';
                statusMessage.textContent = 'Could not reach the server. Please try again in a moment.';
                document.getElementById('step-progress').style.display = 'none';
            }
        });
    </script>
</body>
</html>
