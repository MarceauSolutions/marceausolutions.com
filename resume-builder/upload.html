<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Resume — AI Resume Builder</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1a1a2e; background: #f8f9fa; }

        .header { background: linear-gradient(135deg, #0f0c29, #302b63); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 1.6rem; }
        .header a { color: #00b4d8; text-decoration: none; }

        .container { max-width: 700px; margin: 30px auto; padding: 0 20px; }

        .form-section { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .form-section h2 { margin-bottom: 20px; color: #302b63; border-bottom: 2px solid #00b4d8; padding-bottom: 10px; }

        label { display: block; font-weight: 600; margin: 15px 0 5px; }
        input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #00b4d8; box-shadow: 0 0 0 3px rgba(0,180,216,0.1); }
        textarea { resize: vertical; min-height: 120px; }

        .row { display: flex; gap: 15px; }
        .row > div { flex: 1; }

        .exp-entry { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #00b4d8; }
        .exp-entry h3 { margin-bottom: 10px; font-size: 0.95rem; color: #555; }

        .add-btn { background: none; border: 2px dashed #00b4d8; color: #00b4d8; padding: 12px; border-radius: 8px; width: 100%; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .add-btn:hover { background: rgba(0,180,216,0.05); }

        .remove-btn { background: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; float: right; font-size: 0.8rem; }

        .submit-section { text-align: center; padding: 20px 0; }
        .submit-btn { background: #00b4d8; color: white; padding: 16px 50px; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .submit-btn:hover { background: #0096c7; transform: translateY(-2px); }
        .submit-btn:disabled { background: #aaa; transform: none; cursor: not-allowed; }

        .cost-note { text-align: center; color: #777; margin-top: 10px; font-size: 0.9rem; }

        .status-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .status-box { background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #eee; border-top: 4px solid #00b4d8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) { .row { flex-direction: column; gap: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <h1><a href="index.html">AI Resume Builder</a> &mdash; Build Your Application</h1>
    </div>

    <div class="container">
        <form id="resume-form">
            <!-- Job Posting -->
            <div class="form-section">
                <h2>1. Job Posting</h2>
                <label for="job-posting">Paste the full job description *</label>
                <textarea id="job-posting" name="job_posting_text" rows="8" placeholder="Paste the entire job posting here — include title, company, requirements, responsibilities, qualifications..." required></textarea>
            </div>

            <!-- Contact Info -->
            <div class="form-section">
                <h2>2. Your Contact Info</h2>
                <div class="row">
                    <div>
                        <label for="name">Full Name *</label>
                        <input type="text" id="name" name="name" required placeholder="Jane Doe">
                    </div>
                    <div>
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required placeholder="jane@example.com">
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567">
                    </div>
                    <div>
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" placeholder="City, State">
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label for="linkedin">LinkedIn URL</label>
                        <input type="url" id="linkedin" name="linkedin" placeholder="linkedin.com/in/janedoe">
                    </div>
                    <div>
                        <label for="github">GitHub / Portfolio URL</label>
                        <input type="url" id="github" name="github" placeholder="github.com/janedoe">
                    </div>
                </div>
            </div>

            <!-- Education -->
            <div class="form-section">
                <h2>3. Education</h2>
                <div class="row">
                    <div>
                        <label for="degree">Degree *</label>
                        <input type="text" id="degree" name="degree" required placeholder="B.S. Computer Science">
                    </div>
                    <div>
                        <label for="school">School *</label>
                        <input type="text" id="school" name="school" required placeholder="University of Florida">
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label for="grad-dates">Dates</label>
                        <input type="text" id="grad-dates" name="grad_dates" placeholder="Aug 2018 - May 2022">
                    </div>
                    <div>
                        <label for="gpa">GPA (optional)</label>
                        <input type="text" id="gpa" name="gpa" placeholder="3.8/4.0">
                    </div>
                </div>
            </div>

            <!-- Skills -->
            <div class="form-section">
                <h2>4. Skills</h2>
                <label for="skills">List your technical and professional skills *</label>
                <textarea id="skills" name="skills" rows="4" placeholder="Python, JavaScript, React, AWS, Docker, SQL, Git, CI/CD, Agile, Machine Learning, REST APIs..." required></textarea>
                <p style="color: #777; font-size: 0.85rem; margin-top: 5px;">Comma-separated. Include programming languages, frameworks, tools, and certifications.</p>
            </div>

            <!-- Experience -->
            <div class="form-section">
                <h2>5. Work Experience</h2>
                <div id="experience-entries">
                    <div class="exp-entry" data-index="0">
                        <h3>Position 1 (most recent)</h3>
                        <div class="row">
                            <div>
                                <label>Job Title *</label>
                                <input type="text" name="exp_title_0" required placeholder="Software Engineer">
                            </div>
                            <div>
                                <label>Company *</label>
                                <input type="text" name="exp_company_0" required placeholder="Acme Corp">
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>Location</label>
                                <input type="text" name="exp_location_0" placeholder="San Francisco, CA">
                            </div>
                            <div>
                                <label>Dates</label>
                                <input type="text" name="exp_dates_0" placeholder="Jan 2023 - Present">
                            </div>
                        </div>
                        <label>Key achievements and responsibilities (one per line) *</label>
                        <textarea name="exp_bullets_0" rows="4" placeholder="Built REST API handling 10K requests/day using Python and FastAPI&#10;Led migration from monolith to microservices, reducing deploy time by 60%&#10;Mentored 3 junior developers on testing best practices" required></textarea>
                    </div>
                </div>
                <button type="button" class="add-btn" onclick="addExperience()">+ Add Another Position</button>
            </div>

            <!-- Submit -->
            <div class="submit-section">
                <button type="submit" class="submit-btn" id="submit-btn">Generate My Resume &amp; Cover Letter — $9.99</button>
                <p class="cost-note">Secure payment via Stripe. PDF delivered to your email in ~2 minutes.</p>
            </div>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div class="status-overlay" id="status-overlay">
        <div class="status-box">
            <div class="spinner"></div>
            <h2 id="status-title">Processing Payment...</h2>
            <p id="status-message">You'll be redirected to Stripe for secure checkout.</p>
        </div>
    </div>

    <script>
        let expCount = 1;

        function addExperience() {
            const container = document.getElementById('experience-entries');
            const idx = expCount;
            const entry = document.createElement('div');
            entry.className = 'exp-entry';
            entry.dataset.index = idx;
            entry.innerHTML = `
                <h3>Position ${idx + 1} <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">Remove</button></h3>
                <div class="row">
                    <div><label>Job Title</label><input type="text" name="exp_title_${idx}" placeholder="Software Engineer"></div>
                    <div><label>Company</label><input type="text" name="exp_company_${idx}" placeholder="Acme Corp"></div>
                </div>
                <div class="row">
                    <div><label>Location</label><input type="text" name="exp_location_${idx}" placeholder="City, State"></div>
                    <div><label>Dates</label><input type="text" name="exp_dates_${idx}" placeholder="Jan 2020 - Dec 2022"></div>
                </div>
                <label>Key achievements (one per line)</label>
                <textarea name="exp_bullets_${idx}" rows="3" placeholder="One achievement per line..."></textarea>
            `;
            container.appendChild(entry);
            expCount++;
        }

        // Assemble form data into resume_data.json format
        function buildProfileJSON(formData) {
            const profile = {
                contact: {
                    name: formData.get('name'),
                    phone: formData.get('phone') || '',
                    email: formData.get('email'),
                    linkedin: formData.get('linkedin') || '',
                    github: formData.get('github') || '',
                    location: formData.get('location') || ''
                },
                summaries: { default: '' },
                skills: { technical: formData.get('skills').split(',').map(s => s.trim()).filter(Boolean) },
                experience: {},
                education: {
                    degree: formData.get('degree'),
                    school: formData.get('school'),
                    dates: formData.get('grad_dates') || '',
                    gpa: formData.get('gpa') || ''
                },
                projects: {}
            };

            // Collect experience entries
            for (let i = 0; i < expCount; i++) {
                const title = formData.get(`exp_title_${i}`);
                if (!title) continue;
                const key = `role_${i}`;
                profile.experience[key] = {
                    title: title,
                    company: formData.get(`exp_company_${i}`) || '',
                    location: formData.get(`exp_location_${i}`) || '',
                    dates: formData.get(`exp_dates_${i}`) || '',
                    bullets: (formData.get(`exp_bullets_${i}`) || '').split('\n').map(b => b.trim()).filter(Boolean)
                };
            }

            return profile;
        }

        document.getElementById('resume-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const overlay = document.getElementById('status-overlay');
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');

            // Show loading
            overlay.style.display = 'flex';
            statusTitle.textContent = 'Preparing your order...';
            statusMessage.textContent = 'Building your profile and redirecting to payment...';

            // Build profile JSON
            const profile = buildProfileJSON(formData);
            const jobText = formData.get('job_posting_text');

            // Store data in sessionStorage for after payment
            sessionStorage.setItem('resume_profile', JSON.stringify(profile));
            sessionStorage.setItem('resume_job_text', jobText);
            sessionStorage.setItem('resume_email', formData.get('email'));
            sessionStorage.setItem('resume_name', formData.get('name'));

            // Get tier from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const tier = urlParams.get('tier') || 'single';

            // Redirect to Stripe Checkout
            // For now, use Stripe Payment Link (configured in Stripe Dashboard)
            // The success URL will trigger the n8n webhook with the stored data
            const stripeLinks = {
                'single': 'https://buy.stripe.com/bJe00j29h2Mg6gE0aCg3602',
                'pack3': 'https://buy.stripe.com/14A00jaFN4Uo0WkaPgg3603',
                'unlimited': 'https://buy.stripe.com/eVqbJ14hpeuYdJ67D4g3604'
            };

            // For MVP: redirect to success page which triggers generation
            // (In production, Stripe webhook triggers n8n directly)
            statusTitle.textContent = 'Redirecting to payment...';

            // MVP shortcut: skip Stripe for testing, go straight to generation
            // Replace this block with Stripe redirect in production
            try {
                statusTitle.textContent = 'Generating your resume...';
                statusMessage.textContent = 'AI is analyzing the job posting and tailoring your resume. This takes about 60-90 seconds.';

                const response = await fetch('http://34.193.98.97:5678/webhook/resume-builder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: formData.get('email'),
                        name: formData.get('name'),
                        job_posting_text: jobText,
                        resume_data: profile,
                        stripe_session_id: 'test_session',
                        tier: tier
                    })
                });

                if (response.ok) {
                    window.location.href = 'status.html?status=success';
                } else {
                    statusTitle.textContent = 'Something went wrong';
                    statusMessage.textContent = 'Please try again or contact support at wmarceau@marceausolutions.com';
                }
            } catch (err) {
                statusTitle.textContent = 'Connection error';
                statusMessage.textContent = 'Could not reach the server. Please try again in a moment.';
            }
        });
    </script>
</body>
</html>
